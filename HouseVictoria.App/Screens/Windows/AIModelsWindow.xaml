<Window x:Class="HouseVictoria.App.Screens.Windows.AIModelsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:HouseVictoria.App.Converters"
        mc:Ignorable="d"
        Title="AI Models &amp; Personas" Height="900" Width="1200"
        Style="{StaticResource OverlayWindow}"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <converters:StringEqualsToVisibilityConverter x:Key="StringEqualsToVisibilityConverter"/>
    </Window.Resources>

    <Border Background="Transparent">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" Background="#3000D4FF" Padding="15,10" CornerRadius="6,6,0,0" MouseLeftButtonDown="Header_MouseLeftButtonDown">
                <Border.Effect>
                    <DropShadowEffect Color="#00D4FF" BlurRadius="10" ShadowDepth="0" Opacity="0.3"/>
                </Border.Effect>
                <Grid>
                    <TextBlock Text="ðŸ¤– AI Models &amp; Personas" FontSize="20" FontWeight="Bold" Foreground="#E0F7FF"/>
                    <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                        <Button Content="âˆ’" 
                               Width="30" Height="30" 
                               Background="#4000D4FF" 
                               BorderThickness="0"
                               FontSize="18" FontWeight="Bold"
                               Foreground="#E0F7FF"
                               Cursor="Hand"
                               Margin="0,0,5,0"
                               Click="MinimizeButton_Click"
                               ToolTip="Minimize to Tray">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" 
                                                       CornerRadius="6">
                                                    <ContentPresenter HorizontalAlignment="Center" 
                                                                     VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#6000D4FF"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Content="âœ•" 
                               Width="30" Height="30" 
                               Background="#40FF3366" 
                               BorderThickness="0"
                               FontSize="16" FontWeight="Bold"
                               Foreground="#E0F7FF"
                               Cursor="Hand"
                               Click="CloseButton_Click"
                               ToolTip="Close">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" 
                                                       CornerRadius="6">
                                                    <ContentPresenter HorizontalAlignment="Center" 
                                                                     VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#60FF3366"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Tabs -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="10,5">
                <Button Style="{StaticResource GlassButton}" Content="ðŸ“ Load Model" 
                       Margin="0,0,5,0" Command="{Binding LoadModelCommand}"/>
                <Button Style="{StaticResource GlassButton}" Content="ðŸ‘¤ Create Persona" 
                       Margin="5,0,5,0" Command="{Binding CreatePersonaCommand}"/>
                <Button Style="{StaticResource GlassButton}" Content="ðŸ“– AI Contact Book" 
                       Margin="5,0,5,0" Command="{Binding ShowContactBookCommand}"/>
                <Button Style="{StaticResource GlassButton}" Content="ðŸŽ¨ Image Generation" 
                       Margin="5,0" Command="{Binding ShowImageGenerationCommand}"/>
            </StackPanel>

            <!-- Content Area -->
            <Border Grid.Row="2" Padding="10">
                <StackPanel>
                    <!-- Load Model View -->
                    <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=LoadModel}">
                        <Border Style="{StaticResource Card}" Margin="0,5">
                            <StackPanel>
                                <TextBlock Text="ðŸ“¥ Load Model from Server" FontSize="16" FontWeight="Bold" Foreground="#00D4FF" Margin="0,0,0,10"/>
                                
                                <!-- Ollama Run Section -->
                                <Border Background="#300A0E27" BorderBrush="#4000D4FF" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <TextBlock Text="ðŸš€ Download New Model (Ollama Run)" FontSize="14" FontWeight="Bold" Foreground="#00D4FF" Margin="0,0,0,8"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="150"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="Ollama Run:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                            <TextBox Grid.Column="1" Text="{Binding OllamaRunCommand, UpdateSourceTrigger=PropertyChanged}" 
                                                    Background="#252F3F" BorderBrush="#4000D4FF" 
                                                    Foreground="#E0F7FF" Padding="8" Margin="5,0"
                                                    IsEnabled="{Binding IsPullingModel, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                                                <TextBox.ToolTip>
                                                    <TextBlock>
                                                        Enter model name or ollama run command<LineBreak/>
                                                        Examples: "llama2", "ollama run llama2", "mistral:latest"
                                                    </TextBlock>
                                                </TextBox.ToolTip>
                                            </TextBox>
                                            <Button Grid.Column="2" Style="{StaticResource GlassButton}" Content="â¬‡ï¸ Download" 
                                                   Margin="5,0,0,0" Command="{Binding RunOllamaCommand}"
                                                   IsEnabled="{Binding IsRunningOllamaCommand, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                                            <Button Grid.Column="3" Style="{StaticResource GlassButton}" Content="âœ• Cancel" 
                                                   Margin="5,0,0,0" Command="{Binding CancelOllamaCommand}"
                                                   IsEnabled="{Binding IsRunningOllamaCommand}"/>
                                        </Grid>
                                        <TextBlock Text="{Binding PullModelStatus}" 
                                                  Foreground="#80C4D4" FontSize="12" Margin="0,5,0,0"
                                                  TextWrapping="Wrap"
                                                  Visibility="{Binding PullModelStatus, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="MaxHeight" Value="60"/>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="MaxHeight" Value="300"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <Border Background="#111827" BorderBrush="#4000D4FF" BorderThickness="1" CornerRadius="5" Padding="8" Margin="0,10,0,0">
                                            <StackPanel>
                                                <DockPanel Margin="0,0,0,8">
                                                    <TextBlock Text="Command Output" FontSize="13" FontWeight="Bold" Foreground="#E0F7FF" DockPanel.Dock="Left"/>
                                                    <TextBlock Text="Running..." 
                                                               Foreground="#80C4D4" FontSize="12" HorizontalAlignment="Right"
                                                               Visibility="{Binding IsRunningOllamaCommand, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                </DockPanel>
                                                <TextBox x:Name="LoadModelLogTextBox"
                                                         Text="{Binding LoadModelLog}"
                                                         Background="#0B1220"
                                                         BorderBrush="#4000D4FF"
                                                         Foreground="#E0F7FF"
                                                         FontFamily="Consolas"
                                                         FontSize="12"
                                                         Padding="8"
                                                         TextWrapping="Wrap"
                                                         AcceptsReturn="True"
                                                         IsReadOnly="True"
                                                         VerticalScrollBarVisibility="Auto"
                                                         Height="170"
                                                         TextChanged="LoadModelLogTextBox_TextChanged"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>
                                
                                <Separator Margin="0,0,0,15" Background="#1A2332"/>
                                
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Server Endpoint:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="1" Text="{Binding AvailableModelsEndpoint, UpdateSourceTrigger=PropertyChanged}" 
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0"/>
                                    <Button Grid.Column="2" Style="{StaticResource GlassButton}" Content="ðŸ” Load Models" 
                                           Margin="5,0,0,0" Command="{Binding LoadAvailableModelsCommand}"/>
                                </Grid>
                                <TextBlock Text="Available Models:" FontSize="14" FontWeight="Bold" Foreground="#E0F7FF" Margin="0,15,0,5"/>
                                <ListBox ItemsSource="{Binding AvailableModels}" SelectedItem="{Binding SelectedModel}"
                                        Background="#252F3F" BorderBrush="#4000D4FF" 
                                        Foreground="#E0F7FF" Height="200" Margin="0,5"/>
                                <TextBlock Text="{Binding SelectedModel, StringFormat='Selected: {0}'}" 
                                          Foreground="#80C4D4" FontSize="12" Margin="0,5,0,0"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Create Persona View -->
                    <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=CreatePersona}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,5">
                            <Border Style="{StaticResource Card}" Margin="0,5">
                                <StackPanel>
                                <TextBlock Text="ðŸ‘¤ Create New AI Persona" FontSize="16" FontWeight="Bold" Foreground="#00D4FF" Margin="0,0,0,10"/>
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Name:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="1" Text="{Binding NewPersonaName, UpdateSourceTrigger=PropertyChanged}" 
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0"/>
                                </Grid>
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Model:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1" 
                                            x:Name="ModelComboBox"
                                            ItemsSource="{Binding AvailableModels}" 
                                            Text="{Binding NewPersonaModel, UpdateSourceTrigger=PropertyChanged}"
                                            SelectionChanged="ModelComboBox_SelectionChanged"
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0"
                                            IsEditable="True"
                                            IsEnabled="{Binding IsPullingModel, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                                        <ComboBox.ItemContainerStyle>
                                            <Style TargetType="ComboBoxItem">
                                                <Setter Property="Background" Value="#252F3F"/>
                                                <Setter Property="Foreground" Value="#E0F7FF"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#4000D4FF"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ComboBox.ItemContainerStyle>
                                        <ComboBox.ToolTip>
                                            <TextBlock>
                                                Select a model from the dropdown or type a model name to pull<LineBreak/>
                                                If the model isn't listed, type its name and click Pull
                                            </TextBlock>
                                        </ComboBox.ToolTip>
                                    </ComboBox>
                                    <Button Grid.Column="2" Style="{StaticResource GlassButton}" Content="â¬‡ï¸ Pull" 
                                           Margin="5,0,0,0" Command="{Binding PullModelForPersonaCommand}"
                                           ToolTip="Pull the selected model from Ollama server"
                                           IsEnabled="{Binding IsPullingModel, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>
                                </Grid>
                                <TextBlock Text="{Binding PullModelStatus}" 
                                          Foreground="#CCCCCC" FontSize="12" Margin="0,5,0,0"
                                          TextWrapping="Wrap"
                                          Visibility="{Binding PullModelStatus, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="MaxHeight" Value="60"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="MaxHeight" Value="300"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="MCP Server:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="1" Text="{Binding NewPersonaMCPServer, UpdateSourceTrigger=PropertyChanged}" 
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0"/>
                                </Grid>
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Piper Voice (TTS):" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1" ItemsSource="{Binding AvailablePiperVoices}" 
                                            Text="{Binding NewPersonaPiperVoice, UpdateSourceTrigger=PropertyChanged}"
                                            IsEditable="True"
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0">
                                        <ComboBox.ItemContainerStyle>
                                            <Style TargetType="ComboBoxItem">
                                                <Setter Property="Background" Value="#252F3F"/>
                                                <Setter Property="Foreground" Value="#E0F7FF"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#4000D4FF"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ComboBox.ItemContainerStyle>
                                        <ComboBox.ToolTip>
                                            <TextBlock>Voice used when this AI speaks during calls. Requires Piper TTS running.</TextBlock>
                                        </ComboBox.ToolTip>
                                    </ComboBox>
                                </Grid>
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Description:" Foreground="#E0F7FF" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                    <TextBox Grid.Column="1" Text="{Binding NewPersonaDescription, UpdateSourceTrigger=PropertyChanged}" 
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0" TextWrapping="Wrap" Height="60"/>
                                </Grid>
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="System Prompt:" Foreground="#E0F7FF" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                    <Border Grid.Column="1" Background="#252F3F" BorderBrush="#4000D4FF" BorderThickness="1" CornerRadius="4" Margin="5,0">
                                        <TextBox Text="{Binding NewPersonaSystemPrompt, UpdateSourceTrigger=PropertyChanged}" 
                                                Background="Transparent" BorderThickness="0" 
                                                Foreground="White" Padding="8" 
                                                TextWrapping="Wrap" AcceptsReturn="True" 
                                                VerticalScrollBarVisibility="Auto"
                                                VerticalContentAlignment="Top" 
                                                MinHeight="100" MaxHeight="200"/>
                                    </Border>
                                </Grid>
                                
                                <!-- LLM Parameters Section -->
                                <Expander Margin="0,10,0,5" IsExpanded="False">
                                    <Expander.Header>
                                        <TextBlock Text="âš™ï¸ LLM Parameters (Advanced)" FontSize="14" FontWeight="Bold" Foreground="#00D4FF"/>
                                    </Expander.Header>
                                    <Border Background="#300A0E27" BorderBrush="#4000D4FF" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,5">
                                        <StackPanel>
                                            <!-- Temperature -->
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="150"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="60"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="Temperature:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                                <Slider Grid.Column="1" Minimum="0" Maximum="2" Value="{Binding NewPersonaTemperature, UpdateSourceTrigger=PropertyChanged}" 
                                                       TickFrequency="0.1" IsSnapToTickEnabled="False" Margin="5,0"
                                                       Foreground="#E0F7FF"/>
                                                <TextBlock Grid.Column="2" Text="{Binding NewPersonaTemperature, StringFormat='{}{0:F2}'}" 
                                                          Foreground="#80C4D4" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                            </Grid>
                                            <TextBlock Text="Controls randomness (0.0 = focused, 2.0 = creative)" 
                                                      FontSize="10" Foreground="#5A6A7A" Margin="155,0,0,5"/>
                                            
                                            <!-- Top P -->
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="150"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="60"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="Top P:" Foreground="White" VerticalAlignment="Center"/>
                                                <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding NewPersonaTopP, UpdateSourceTrigger=PropertyChanged}" 
                                                       TickFrequency="0.05" IsSnapToTickEnabled="False" Margin="5,0"
                                                       Foreground="#E0F7FF"/>
                                                <TextBlock Grid.Column="2" Text="{Binding NewPersonaTopP, StringFormat='{}{0:F2}'}" 
                                                          Foreground="#80C4D4" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                            </Grid>
                                            <TextBlock Text="Nucleus sampling - controls diversity via probability" 
                                                      FontSize="10" Foreground="#5A6A7A" Margin="155,0,0,5"/>
                                            
                                            <!-- Top K -->
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="150"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="60"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="Top K:" Foreground="White" VerticalAlignment="Center"/>
                                                <Slider Grid.Column="1" Minimum="1" Maximum="100" Value="{Binding NewPersonaTopK, UpdateSourceTrigger=PropertyChanged}" 
                                                       TickFrequency="1" IsSnapToTickEnabled="True" Margin="5,0"
                                                       Foreground="#E0F7FF"/>
                                                <TextBlock Grid.Column="2" Text="{Binding NewPersonaTopK}" 
                                                          Foreground="#80C4D4" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                            </Grid>
                                            <TextBlock Text="Limits sampling to top K most likely tokens" 
                                                      FontSize="10" Foreground="#5A6A7A" Margin="155,0,0,5"/>
                                            
                                            <!-- Repeat Penalty -->
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="150"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="60"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="Repeat Penalty:" Foreground="White" VerticalAlignment="Center"/>
                                                <Slider Grid.Column="1" Minimum="0" Maximum="2" Value="{Binding NewPersonaRepeatPenalty, UpdateSourceTrigger=PropertyChanged}" 
                                                       TickFrequency="0.1" IsSnapToTickEnabled="False" Margin="5,0"
                                                       Foreground="#E0F7FF"/>
                                                <TextBlock Grid.Column="2" Text="{Binding NewPersonaRepeatPenalty, StringFormat='{}{0:F2}'}" 
                                                          Foreground="#80C4D4" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                            </Grid>
                                            <TextBlock Text="Penalizes repetition (higher = less repetition)" 
                                                      FontSize="10" Foreground="#5A6A7A" Margin="155,0,0,5"/>
                                            
                                            <!-- Max Tokens -->
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="150"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="Max Tokens:" Foreground="White" VerticalAlignment="Center"/>
                                                <TextBox Grid.Column="1" Text="{Binding NewPersonaMaxTokens, UpdateSourceTrigger=PropertyChanged}" 
                                                        Background="#252F3F" BorderBrush="#4000D4FF" 
                                                        Foreground="#E0F7FF" Padding="8" Margin="5,0"/>
                                            </Grid>
                                            <TextBlock Text="Maximum tokens to generate (-1 = unlimited)" 
                                                      FontSize="10" Foreground="#5A6A7A" Margin="155,0,0,5"/>
                                            
                                            <!-- Context Length -->
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="150"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="Context Length:" Foreground="White" VerticalAlignment="Center"/>
                                                <TextBox Grid.Column="1" Text="{Binding NewPersonaContextLength, UpdateSourceTrigger=PropertyChanged}" 
                                                        Background="#252F3F" BorderBrush="#4000D4FF" 
                                                        Foreground="#E0F7FF" Padding="8" Margin="5,0"/>
                                            </Grid>
                                            <TextBlock Text="Size of the context window (varies by model)" 
                                                      FontSize="10" Foreground="#5A6A7A" Margin="155,0,0,5"/>
                                        </StackPanel>
                                    </Border>
                                </Expander>
                                
                                <Button Content="ðŸ’¾ Create Persona" 
                                       Margin="0,15,0,5" HorizontalAlignment="Right" Width="200"
                                       Command="{Binding SavePersonaCommand}"
                                       ToolTip="Create a new AI persona with the specified name and model">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource GlassButton}">
                                            <Style.Triggers>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="Opacity" Value="0.5"/>
                                                    <Setter Property="ToolTip" Value="Please enter a name and select/type a model name"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>
                        </Border>
                        </ScrollViewer>
                    </StackPanel>

                    <!-- AI Contact Book View -->
                    <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=ContactBook}">
                        <Border Style="{StaticResource Card}" Margin="0,5">
                            <StackPanel>
                                <TextBlock Text="ðŸ“– AI Contact Book" FontSize="16" FontWeight="Bold" Foreground="#00D4FF" Margin="0,0,0,10"/>
                                <ItemsControl ItemsSource="{Binding AIContacts}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource Card}" Margin="0,5" Padding="10">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="Bold" Foreground="#E0F7FF"/>
                                                        <TextBlock Text="{Binding Description}" FontSize="12" Foreground="#80C4D4" Margin="0,2,0,0"/>
                                                        <TextBlock FontSize="11" Foreground="#5A6A7A" Margin="0,2,0,0">
                                                            <Run Text="Model: "/>
                                                            <Run Text="{Binding ModelName}"/>
                                                            <Run Text=" | "/>
                                                            <Run Text="{Binding IsLoaded, StringFormat='Loaded: {0}'}"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                        <Button Style="{StaticResource GlassButton}" Content="ðŸ“‚ Load" 
                                                               Margin="5,0" Command="{Binding DataContext.LoadPersonaCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                               CommandParameter="{Binding}"/>
                                                        <Button Style="{StaticResource GlassButton}" Content="âœï¸ Edit" 
                                                               Margin="5,0" Command="{Binding DataContext.EditPersonaCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                               CommandParameter="{Binding}"/>
                                                        <Button Style="{StaticResource GlassButton}" Content="ðŸ—‘ï¸" 
                                                               Margin="5,0" Command="{Binding DataContext.DeletePersonaCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                               CommandParameter="{Binding}"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Text="No AI contacts found. Create a new persona to get started." 
                                          FontSize="12" Foreground="#5A6A7A" 
                                          HorizontalAlignment="Center" Margin="0,20">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding AIContacts.Count}" Value="0">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Image Generation View -->
                    <StackPanel Visibility="{Binding CurrentView, Converter={StaticResource StringEqualsToVisibilityConverter}, ConverterParameter=ImageGeneration}">
                        <Border Style="{StaticResource Card}" Margin="0,5">
                            <StackPanel>
                                <TextBlock Text="ðŸŽ¨ AI Image Generation" FontSize="16" FontWeight="Bold" Foreground="#00D4FF" Margin="0,0,0,10"/>
                                
                                <!-- Image Generation Prompt -->
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Prompt:" Foreground="#E0F7FF" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                    <TextBox Grid.Column="1" Text="{Binding ImageGenerationPrompt, UpdateSourceTrigger=PropertyChanged}" 
                                            Background="#252F3F" BorderBrush="#4000D4FF" 
                                            Foreground="White" Padding="8" Margin="5,0" 
                                            TextWrapping="Wrap" Height="100" AcceptsReturn="True"/>
                                </Grid>

                                <!-- Generation Options -->
                                <Grid Margin="0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Width:" Foreground="#E0F7FF" VerticalAlignment="Center"/>
                                    <Slider Grid.Column="1" Minimum="256" Maximum="1024" Value="{Binding ImageWidth}" 
                                           TickFrequency="128" IsSnapToTickEnabled="True" Margin="5,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding ImageWidth, StringFormat='{}Width: {0}px'}" 
                                              Foreground="#80C4D4" VerticalAlignment="Top" Margin="5,25,0,0"/>
                                </Grid>

                                <Grid Margin="0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Height:" Foreground="White" VerticalAlignment="Center"/>
                                    <Slider Grid.Column="1" Minimum="256" Maximum="1024" Value="{Binding ImageHeight}" 
                                           TickFrequency="128" IsSnapToTickEnabled="True" Margin="5,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding ImageHeight, StringFormat='{}Height: {0}px'}" 
                                              Foreground="#80C4D4" VerticalAlignment="Top" Margin="5,25,0,0"/>
                                </Grid>

                                <!-- Generate Button -->
                                <Button Content="ðŸŽ¨ Generate Image" 
                                       Margin="0,15,0,5" HorizontalAlignment="Right" Width="200"
                                       Command="{Binding GenerateImageCommand}"
                                       IsEnabled="{Binding IsGeneratingImage, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource GlassButton}">
                                            <Style.Triggers>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="Opacity" Value="0.5"/>
                                                    <Setter Property="ToolTip" Value="Please enter a prompt to generate an image"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <!-- Status and Preview -->
                                <TextBlock Text="{Binding ImageGenerationStatus}" 
                                          Foreground="#CCCCCC" FontSize="12" Margin="0,10,0,0"
                                          TextWrapping="Wrap"
                                          Visibility="{Binding HasImageGenerationStatus, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="MaxHeight" Value="60"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="MaxHeight" Value="300"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <!-- Generated Image Preview -->
                                <Border Background="#300A0E27" BorderBrush="#4000D4FF" BorderThickness="1" 
                                       CornerRadius="5" Padding="10" Margin="0,10,0,0"
                                       Visibility="{Binding HasGeneratedImage, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="Generated Image:" FontSize="14" FontWeight="Bold" Foreground="#E0F7FF" Margin="0,0,0,10"/>
                                        <Image Source="{Binding GeneratedImagePath}" 
                                              MaxWidth="512" MaxHeight="512" 
                                              Stretch="Uniform" 
                                              HorizontalAlignment="Center"/>
                                        <Button Content="ðŸ’¾ Save Image" 
                                               Style="{StaticResource GlassButton}" 
                                               Margin="0,10,0,0" Width="150"
                                               Command="{Binding SaveGeneratedImageCommand}"
                                               HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
    </Border>

</Window>
